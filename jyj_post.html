<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post</title>
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/jyj_post.css">
</head>
<body>
  <article class="post">
    <header class="top-basic-nav">
      <h2 class="blind">ìƒë‹¨ê¸°ë³¸ë„¤ë¹„ê²Œì´ì…˜</h2>
      <div class="arrow"></div>
      <div class="more"></div>
    </header>

    <main>
      <section class="container">
      </section>
    </main>

    <footer class="container off">
    </footer>

    <article class="comment off">
      <h2 class="blind">ì½”ë©˜íŠ¸</h2>
      <div class="icon"></div>
      <input class="text" placeholder="ëŒ“ê¸€ ì…ë ¥í•˜ê¸°..."></input>
      <div class="posting">ê²Œì‹œ</div>
    </article>
  </article>

  <section class="icon-post-modal">
    <div class="modalBox">
        <div class="topBar"></div>
        <div class="deleteBox">ì‚­ì œ</div>
        <div class="modifyBox">ìˆ˜ì •</div>
    </div>
  </section>

<script>

document.querySelector(".comment .icon").style.background = `url(${localStorage.getItem("image")})`;

// (ë‚ ì§œ refactoring) : ë…„ì›”ì¼ ë¶™ì—¬ì£¼ê¸° + ì›”, ì¼ ì•ì— 0 ë¶™ì–´ìˆìœ¼ë©´ ì œê±°
function date_refactoring(date) {
  date = date + '';
  let date1 = ''; 
  let date2 = ''; 
  // ğŸ‹ğŸ‹ğŸ‹ date2ì—” ë‚ ì§œê°€ ì˜¤ëŠ˜ì´ë©´ ëª‡ì‹œëª‡ë¶„ì¸ì§€ ì°ì–´ì£¼ê¸°, 60ë¶„ ì´ë‚´ë©´ ëª‡ë¶„ ì „, 1ë¶„ ì´ë‚´ë©´ ë°©ê¸ˆ ì „?
  date1 = date.slice(0,4) + 'ë…„ ' 
        + (date[5] === '0' ? date.slice(6,7) : date.slice(5,7)) + 'ì›” '
        + (date[8] === '0' ? date.slice(9,10) : date.slice(8,10)) + 'ì¼ ';
  return date1;
}


// ğŸ‹ğŸ‹ğŸ‹ ë‚˜ì¤‘ì— í•´ë‹¹ ê²Œì‹œë¬¼ì˜ idë¥¼ ë°›ì•„ì˜¤ë„ë¡ ë°”ê¿”ì¤˜ì•¼ í•  ë“¯
localStorage.setItem("post_id", "61e3b32b848431e191bca67e"); 


// (5.4 ê²Œì‹œê¸€ ìƒì„¸)
get_post();
async function get_post() {
  let res = await fetch(localStorage.getItem("url")+"post/"+localStorage.getItem("post_id"), {
    method: "GET",
    headers: {
        "Authorization" : "Bearer "+localStorage.getItem("key"),
        "Content-Type": "application/json"
    }
  })
  response = await res.json();
  
  console.log("5.4ê²Œì‹œê¸€ ìƒì„¸ API - res.json()");
  console.log(response);

  let section_container = document.querySelector('Section.container');
  let date1 = date_refactoring(response.post.updatedAt + '');
  
  // í•˜íŠ¸ê°œìˆ˜ refactoring : ì—†ìœ¼ë©´ undefined ë¡œ ì°í˜€ë“¤ì–´ì˜¤ëŠ” ê²ƒ ë°©ì§€
  let heart = (response.post.heartcount ? response.post.heartcount : 0);
  section_container.innerHTML = "";
  section_container.innerHTML = `
    <section class="home-post">
      <section class="leftSide">
        <button type="button" class="proPic"><img src="${response.post.author.image}" alt="í”„ë¡œí•„ì´ë¯¸ì§€"></button>
      </section>
      <section class="rightSide">
        <div class="menuWrap">
          <div class="proId">
            <p>${response.post.author.username}</p>
            <p>@ ${response.post.author.accountname}</p>
          </div>
          <button class="menuBtn" type="button">
            <img src="img/more-icon.png" alt="ë”ë³´ê¸°ì•„ì´ì½˜">
          </button>
        </div>
        <div class="cntTxt">
          <p>${response.post.content}</p>
        </div>  
        <div class="cntImg">
          <img src="${response.post.image}" alt="ì½˜í…íŠ¸ì´ë¯¸ì§€">
        </div>
        <div class="btnWrap">
          <div class="btnLike">
            <div class="button"></div>
            <p>${heart}</p>
          </div>
          <div class="btnCmt">
            <button type="button">
              <img src="img/icon-message-circle.png" alt="ëŒ“ê¸€ì•„ì´ì½˜">
            </button>
            <p>${response.post.commentCount}</p>
          </div>
        </div>
        <p class="date">${date1}</p>
      </section>
    </section>
    `

  // í•˜íŠ¸ ì•„ì´ì½˜ í´ë¦­ì‹œ í•˜íŠ¸ìƒ‰ê¹” ë° +1 ë¨
  let toggle = 1;
  let btnLike = document.querySelector('.btnLike');
  btnLike.addEventListener('click', function(){
    document.querySelector('.btnLike .button').classList.toggle('on');
    let number = Number(document.querySelector('.btnLike p').innerText);
    console.log(number);
    document.querySelector('.btnLike p').innerText = number + toggle;
    if (toggle == 1) {toggle = -1;} else {toggle = 1;}
  });
}


// (7.2 ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸)
get_comment();
async function get_comment() {
  let res = await fetch(localStorage.getItem("url")+"post/"+localStorage.getItem("post_id")+"/comments", {
    method: "GET",
    headers: {
        "Authorization" : "Bearer " + localStorage.getItem("key"),
        "Content-Type": "application/json"
      }
  })
  response = await res.json();

  console.log("7.2 ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ API - res.json()");
  console.log(response);

  let commentbox = document.querySelector('footer.container');
  let max = response.comments.length; 
  commentbox.innerHTML = ""
  for (let index = 0; index < max; index++) {
    let date = date_refactoring(response.comments[max-index-1].createdAt)
    commentbox.innerHTML += `
      <section class="cont-info">
        <img src="${response.comments[max-index-1].author.image}" alt="">
        <article class="com-list">
          <section class="list-com">
            <p class="title">${response.comments[max-index-1].author.username}</p>
            <p class="time">${date}</p>
            <div class="more" data-id="${response.comments[max-index-1].id}"></div>
          </section>
          <p class="cont">${response.comments[max-index-1].content}</p>
          <div class="you">ì‹ ê³ í•˜ê¸°</div>
          <div class="me">ì‚­ì œ</div>
        </article>
      </section>
    `       
  }

  // ëŒ“ê¸€ ì•„ì´ì½˜ í´ë¦­ì‹œ ëŒ“ê¸€ì°½ ë‚˜íƒ€ë‚¨
  let btnCmt = document.querySelector('.btnCmt');
  btnCmt.addEventListener('click', function(){
    document.querySelector('.comment').classList.toggle('off');
    document.querySelector('footer.container').classList.toggle('off');
  });

  // // ëŒ“ê¸€ì˜ more ë²„íŠ¼ í´ë¦­ì‹œ ì‹ ê³ í•˜ê¸° ë˜ëŠ” ì‚­ì œ ëª¨ë‹¬ì°½ ë‚˜íƒ€ë‚¨ 
  // meandyou();
  // function meandyou() {    
  //   let modal = document.querySelectorAll('footer.container .more');
  //   let you = document.querySelectorAll('footer.container .you');
  //   let me = document.querySelectorAll('footer.container .me');
  //   for (let index = 0; index < modal.length; index++) {
  //     modal[index].addEventListener('click', function(){
  //       if(index < 2) {
  //         you[index].classList.toggle('modal');
  //       } else {
  //         me[index].classList.toggle('modal');
  //       }
  //     });   
  //   };
  // }
  

  // (7.3 ëŒ“ê¸€ ì‚­ì œ)
  let comments = document.querySelectorAll('.list-com .more');
  let modal = document.querySelector('.icon-post-modal'); 
  let exit = modal.querySelector('.topBar');
  let deletebtn = modal.querySelector('.deleteBox');
  for (let index = 0; index < comments.length; index++) {
    let comment_id = comments[index].dataset.id;
    console.log(comment_id);
    comments[index].addEventListener('click', (event) => {
      modal.style.display = "block";
      deletebtn.addEventListener('click', async () => {
        let res = await fetch(localStorage.getItem("url")+"post/"+localStorage.getItem("post_id")+"/comments/"+comment_id, {
          method: "DELETE",
          headers: {
              "Authorization" : "Bearer " + localStorage.getItem("key"),
              "Content-Type": "application/json"
            }
        })
        response = await res.json();
        console.log("7.3 ëŒ“ê¸€ ì‚­ì œ API - res.json()");
        console.log(response);
        modal.style.display = "none";
        get_post();
        get_comment();
      })
    })
  }
  exit.addEventListener('click', () => {
    modal.style.display = "none";
  })
} 


// (7.1 ëŒ“ê¸€ ì‘ì„±)
let comment_btn = document.querySelector(".posting"); 
let comment_text = document.querySelector(".text");
comment_btn.addEventListener('click', post_comment);
comment_text.addEventListener('keyup', (event) => {
  if(event.key === 'Enter'){post_comment()}
});
async function post_comment() {
  let text = comment_text.value + "";
  let res = await fetch(localStorage.getItem("url")+"post/"+localStorage.getItem("post_id")+"/comments", {
    method: "POST",
    headers: {
        "Authorization" : "Bearer " + localStorage.getItem("key"),
        "Content-Type": "application/json"
      },
    body: JSON.stringify({
        "comment" : {
          "content": text
        }
      })
  })
  response = await res.json();

  console.log("7.1 ëŒ“ê¸€ ì‘ì„± API - res.json()");
  console.log(response);

  get_post();
  get_comment();
  comment_text.value = "";
}


  </script>
</body>
</html>