<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/reset.css">
  <link rel="stylesheet" href="./css/jyj_upload.css">
  <title>upload</title>
</head>
<body>
  <section class="top-upload-nav">
    <h2 class="blind">ìƒë‹¨ì—…ë¡œë“œë„¤ë¹„ê²Œì´ì…˜</h2>
    <div class="arrow"></div>
    <button class="save">ì—…ë¡œë“œ</button>
  </section>
  <section class="upload">
    <div class="icon"></div>
    <section class="comment">
      <h2 class="blind">ê²Œì‹œê¸€</h2>
      <form>
        <textarea class="text"  rows="5" placeholder="ê²Œì‹œê¸€ ì…ë ¥í•˜ê¸°..."></textarea>
        <input class="img-file" type="file" accept="img/*" name="upload_image[]" multiple style="display: none;"></input>
      </form>
      <label class="img" for="img-file"></label>
    </section>
  </section>
  <script>

    let img = document.querySelector('.img');
    let imgfile = document.querySelector('.img-file');
    let text = document.querySelector(".text")
    let submitBtn = document.querySelector(".save")
    let element = [];
    let actionboolean = false;

    // FRONT-END PART : ì´ë¯¸ì§€ ë¶ˆëŸ¬ì™€ì„œ ë¸Œë¼ìš°ì €ì— ë¯¸ë¦¬ë³´ê¸° ì œê³µ

    img.addEventListener('click', function (event) { 
      imgfile.click();
    });

    imgfile.addEventListener('change', function (event) { 
      console.log("ì´ë¯¸ì§€ íŒŒì¼ì˜ ê°œìˆ˜ëŠ” ì´ â­" + event.target.files.length + "ê°œâ­ ì…ë‹ˆë‹¤. ì°¸ê³ í•˜ì„¸ìš”.");
      for (let index = 0; index < event.target.files.length; index++) {
        let reader = new FileReader();
        reader.readAsDataURL(event.target.files[index]);
        reader.onload = function (e) {
          // console.log(reader.result);
          element[index] = reader.result;
          console.log("ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ì—¬ê¸°ëŠ” read.onloadê°€ ì‹¤í–‰ë˜ëŠ” ìˆœê°„ì…ë‹ˆë‹¤ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜");
          console.log("í˜„ì¬ ì¸ë±ìŠ¤ëŠ” " + index + "ì…ë‹ˆë‹¤. ì´ë¯¸ì§€ ì£¼ì†ŒëŠ” " + element[index]);
          let booleansum = 0 ; 
          for (let i = 0; i < event.target.files.length; i++) {
            booleansum += Boolean(element[i]);
          }
          console.log("í˜„ì¬ ë¶ˆë¦°ì„¬ì€"+booleansum+"ì…ë‹ˆë‹¤");
          if (booleansum === event.target.files.length) {
            frameaction();
          }
        }
      }
    });
    
    function frameaction(){
      console.log("ğŸ‹ğŸ‹ğŸ‹ğŸ‹ğŸ‹ì´ë¯¸ì§€ íŒŒì¼ ê°œìˆ˜ì™€ ë¶ˆë¦°ì„¬ì´ ê°™ì•„ì¡Œë‹¤ë©´ frameactionì´ ì‹¤í–‰ë˜ëŠ” ìˆœê°„ì…ë‹ˆë‹¤ğŸ‹ğŸ‹ğŸ‹ğŸ‹ğŸ‹");
      let comment = document.querySelector('.comment');
      let myimage = document.createElement('div');
      // console.log(element);
      // console.log("test: " + element.length);
      if(element.length > 1){
        myimage.innerHTML = `
          <div style="width:300px; overflow:scroll;">
            <div class="frame" style="width:${180*element.length}px;">
            </div>
          </div>
        `;
        comment.appendChild(myimage);
        let frame = document.querySelector('.frame');
        for (let index = 0; index < element.length; index++) {
          let multiimage = document.createElement('span');
          multiimage.innerHTML = `
            <div style="
              display: inline-block;
              box-sizing: border-box;
              width: 170px;
              height: 125px;
              border-radius: 10px;
              border: #bdbdbd 1px solid;
              background: url(${element[element.length-index-1]}) center center no-repeat;
              background-size: auto 125px;
            "></div>
          `;
          frame.appendChild(multiimage);
          console.log("ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯ì—¬ê¸°ëŠ” multiimage 1ê°œê°€ ì£¼ì…ë˜ëŠ” ìˆœê°„ì…ë‹ˆë‹¤ğŸ¯ğŸ¯ğŸ¯ğŸ¯ğŸ¯");
        }
        // console.log(frame);
      } else {    
        myimage.innerHTML = `
          <div style="
            display: inline-block;
            margin-top: 16px;
            box-sizing: border-box;
            width: 100%;
            height: 230px;
            border-radius: 10px;
            background: url(${element[0]}) center center no-repeat;
            background-size: auto 230px;
          "></div>
        `;
        comment.appendChild(myimage);
      }
    };

    // BACK-END PART : ì„œë²„ì— ì´ë¯¸ì§€ ì˜¬ë¦¬ê³ , íŒŒì¼ëª… ë°›ì•„ì™€ì„œ, í¬ìŠ¤íŒ…

    const url = "http://146.56.183.55:5050/"

    async function imageUpload(files,index) {
        const formData = new FormData();
        formData.append("image", files[index]);//formData.append("í‚¤ì´ë¦„","ê°’")
        const res = await fetch(url+'image/uploadfile', {
            method: "POST",
            body : formData
        })
        const data = await res.json()
        console.log(data);
        const productImgName = data["filename"];
        console.log(productImgName);
        return productImgName
    }
    async function createPost(e) {        
        const token = localStorage.getItem("key")
        //ì…ë ¥í•œ í…ìŠ¤íŠ¸ ë¶ˆëŸ¬ì™€ì•¼í•¨
        const contentText = text.value
        //ì—¬ê¸°ëŠ” ë‚˜ì¤‘ì— ì´ë¯¸ì§€ ì£¼ì†Œê°€ ì¶”ê°€ë  ì˜ˆì •
        const imageUrls = []
        const files = imgfile.files
        //fileê°¯ìˆ˜ë¥¼ íŒë³„í•˜ì—¬ 3ê°œ ì´í•˜ì¼ë•Œë§Œ ì‹¤í–‰í•˜ê²Œí•œë‹¤.
        if (files.length<=3) {
            // fileì„ ì…ë ¥í•œ ê°¯ìˆ˜ë§Œí¼ ë°˜ë³µí•´ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ì´ë¯¸ì§€ urlë°°ì—´ì— ì¶”ê°€ë˜ëŠ”ë¶€ë¶„
            for (let index = 0; index < files.length; index++) {
                const imgurl = await imageUpload(files,index)
                //ì™„ì„±ëœ urlì„ ë§Œë“¤ì–´ì„œ ë„£ì–´ì¤€ë‹¤.
                imageUrls.push(url+imgurl)
            }
            const res = await fetch(url+"post",{
                method:"POST",
                headers:{
                            "Authorization" : `Bearer ${token}`,//í† í°ì„ ë„£ì–´ì¤ë‹ˆë‹¤. 
                            "Content-type" : "application/json"
                },
                body:JSON.stringify({
                    "post": {
                            "content": contentText,
                            "image": imageUrls+'' //"imageurl1", "imageurl2" í˜•ì‹ìœ¼ë¡œ 
                    }
                })
            })
            const json = await res.json()
            console.log(json)
        }else{
            alert("ì•„ ì´ë¯¸ì§€ ê°¯ìˆ˜ê°€ ë„ˆë¬´ ë§ì†Œ")
        }
        
    }
    //ì—¬ê¸°ê¹Œì§€ ì´ë¯¸ì§€ ì—¬ëŸ¬ê°œ ì—…ë¡œë“œí•˜ê¸°.
    submitBtn.addEventListener('click',createPost)

  </script>
</body>
</html>