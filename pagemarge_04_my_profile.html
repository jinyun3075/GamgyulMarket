<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/pagemarge_04_my_profile.css">
    <title>4_My Profile</title>
</head>
<body>
    <header class="profileHeader">
        <img src="../img/icon-arrow-left.png" class="leftArrow" alt="">
        <img src="../img/more-icon.png" class="moreIcon" alt="">
    </header>
    <!-- 프로필 -->
    <section class="profileMain">
    </section>
    <!-- 상품 -->
    <section class="sellProduct">
        <p>판매 중인 상품</p>
    </section>

    <!-- 게시글 -->
    <section class="top-main-nav">
        <h2 class="blind">상단메인네비게이션</h2>
        <img src="../img/icon-post-list-on.png" art="게시물 리스트" class="image1">
        <img src="../img/icon-post-album-off.png" alt="앨범식으로 보기" class="image2">
    </section>
    <!-- 게시글 - 1 -->
    <div class="yourprofile">
    </div>
    <!-- 게시글 - 2 -->
    <section class="m-container album">
        <section class="pics">
        </section>
    </section>

    <!-- tab-menu -->
    <section class="tab-menu">
        <h2 class="blind">탭메뉴</h2>
        <div class="home"><span></span><p>홈</p></div>
        <div class="chatting"><span></span><p>채팅</p></div>
        <div class="create"><span></span><p>게시물 작성</p></div>
        <div class="profile"><span></span><p>프로필</p></div>
    </section>

    <!-- modal -->
    <section class="icon-post-modal">
        <div class="modalBox">
            <div class="topBar"></div>
            <div class="deleteBox">삭제</div>
            <div class="modifyBox">수정</div>
        </div>
    </section>

    <section class="icon-product-modal">
        <div class="modalBox">
            <div class="topBar"></div>
            <div class="deleteBox_2">삭제</div>
            <div class="modifyBox_2">수정</div>
            <div class="websiteBox">웹사이트에서 상품 보기</div>
        </div>
    </section>

    <!-- 스크립트 연결 -->

    <script>
        const $body = document.querySelector('body');
        const $productlist = $body.querySelector('.sellProduct');
        const $cont = $body.querySelector('.yourprofile');
        const $nav = $body.querySelector('.top-main-nav');
        const $album = $body.querySelector('.m-container');
        const $image1 = $body.querySelector('.image1');
        const $image2 = $body.querySelector('.image2');
        const $profile = $body.querySelector('.profileMain');
        const $modal = $body.querySelector('.icon-post-modal');
        const $back = $body.querySelector('.leftArrow');
        const $home = $body.querySelector('.home');
        $home.onclick = ()=> {
            location.href = "sjy_01_home-2.html";
        }
        $back.onclick = ()=> {
            history.back();
        }
        //유저 정보
        async function userinfo() {
            const res = await fetch(localStorage.getItem("url")+"profile/"+localStorage.getItem("username"),{
                headers: {
                    "Authorization" : "Bearer "+localStorage.getItem("key"),
                    "Content-Type": "application/json"
                }
            })
            const resJson = await res.json();
            $profile.innerHTML =`
                <article class="followImageBox">
                <div class="followers">
                    <p class="followersNumber">${resJson.profile.followerCount}</p>
                    <p>followers</p>
                </div>
                <img src="${resJson.profile.image}" alt="">
                <div class="followings">
                    <p class="followingsNumber">${resJson.profile.followingCount}</p>
                    <p>followings</p>
                </div>
                </article>
                <article class="profileNameBox">
                    <p class="marketName">${resJson.profile.username}</p>
                    <p class="marketEmail">@ weniv_Mandarin</p>
                    <p>${resJson.profile.intro}</p>
                </article>
                <article class="profileButtonBox">
                    <button class="profileUpdate">프로필 수정</button>
                    <button class="productUpdate">상품 등록</button>
                </article>
                <article class="profileButtonBox">
                    <button class="messageButton"></button>
                    <button class="followButton">팔로우</button>
                    <button class="shareButton"></button>
                </article>
            `
            const $productupdate = $body.querySelector('.productUpdate');
            const $profileupdate = $body.querySelector('.profileUpdate');
            $productupdate.onclick = ()=>{
                location.href = "jyj_add_product.html";
            }
            $profileupdate.onclick = ()=>{
                location.href = "msy_profile_modification.html";
            }
        }

        // 상품 리스트
        const ProductList = async ()=> {
            const res = await fetch(localStorage.getItem("url")+"product/"+localStorage.getItem("username"),{
            headers: {
                "Authorization" : "Bearer "+localStorage.getItem("key"),
                "Content-Type": "application/json"
            }
            })
            const resJson = await res.json();
            // resJson.data=0;//없을떄)
            if (resJson.data=="0"){
                $productlist.style.display ="none";
            }else  {
                for (const data of resJson.product) {    
                    $productlist.innerHTML +=`
                    <div class="product">
                        <img src="${data.itemImage}" class="productImg" alt="프로덕트이미지">
                        <p class="productName">${data.itemName}</p>
                        <p class="productPrice">${data.price}원</p>
                        </div>
                        `
                }
            }
        }

        // 게시물 리스트
        $image1.onclick = ()=>{
            $image1.src = "../img/icon-post-list-on.png";
            $image2.src = "../img/icon-post-album-off.png";
            $album.style.display="none";
            $cont.style.display="block"
        }
        $image2.onclick = ()=>{
            $image1.src = "../img/icon-post-list-off.png";
            $image2.src = "../img/icon-post-album-on.png";
            $album.style.display="block";
            $cont.style.display="none"
        }
        async function album() {
            const res = await fetch(localStorage.getItem("url")+"post/"+localStorage.getItem("username")+"/userpost", {
                headers: {
                    "Authorization" : "Bearer "+localStorage.getItem("key"),
                    "Content-Type": "application/json"
                }
            })
            resJson = await res.json();
            let $pics = $album.querySelector('.pics');
            for (const data of resJson.post) {
                let div = document.createElement("div");
                div.className = "pic";
                div.style.backgroundImage = `url("./img/${data.image}")`
                $pics.appendChild(div);
            }
            
            }
        
        async function mylist() {
            const res = await fetch(localStorage.getItem("url")+"post/"+localStorage.getItem("username")+"/userpost", {
                headers: {
                    "Authorization" : "Bearer "+localStorage.getItem("key"),
                    "Content-Type": "application/json"
                }
            })
            resJson = await res.json();
            // resJson = {}; // 없을때
            if(!resJson.post){
                $nav.style.display = "none"
            }else{
                $cont.innerHTML="";
                for (const data of resJson.post) {
                    let heart = '<button class="heatbtn"  type="button"><img src="../img/icon-heart.png" alt="좋아요아이콘"></button>'
                    if(data.hearted) {
                        heart = '<button class="heatbtn on" type="button"><img src="../img/icon-heart2.png" alt="좋아요아이콘"></button>'
                    }
                    $cont.innerHTML += 
                    `<section class="home-post">
                        <section class="leftSide">
                        <button type="button" class="proPic"><img src="${data.author.image}" alt="프로필이미지"></button>
                        </section>
                        <section class="rightSide">
                        <div class="menuWrap">
                            <div class="proId">
                            <p>${data.author.username}</p>
                            <p>@ naver.com</p>
                            </div>
                            <button class="menuBtn" type="button"><img src="../img/more-icon.png" alt="더보기아이콘" id="${data.id}"></button>
                            </div>
                            <div class="cntTxt">
                                <p>${data.content}</p>
                                </div>
                                <div class="cntImg">
                                    <img src="../img/${data.image}" alt="콘텐트이미지">
                                    </div>
                                    <div class="btnWrap">
                                        <div class="btnLike">
                                            ${heart}
                                            <input type="hidden" value="${data.id}"/>
                                            <p>${data.heartCount}</p>
                                        </div>
                                    <div class="btnCmt">
                                    <button type="button"><img src="../img/icon-message-circle.png" alt="댓글아이콘"></button>
                                    <p>${data.commentCount}</p>
                                </div>
                            </div>
                        <p class="date">${data.createdAt}</p>
                        </section>
                    </section> `
                    
                }
                let $heartbtn = $cont.querySelectorAll('.heatbtn');
                for (const object of $heartbtn) {    
                    object.onclick = (e)=>{
                        const btn = e.target;
                        const id = btn.parentNode.parentNode.querySelector('input').value
                        const check = e.target.parentNode.classList.contains('on');
                        if (check) {
                            e.target.classList.remove('.on');
                            unheartCheck(id);
                        } else {
                            e.target.classList.add('.on');
                            heartCheck(id);
                        }
                        
                    };
                }
                // 모달 창
                let $modalbtn = $body.querySelectorAll('.menuBtn');
                for (const object of $modalbtn) {   
                    object.onclick = (e)=>{
                        $modal.style.display = "block";
                        const exit = $modal.querySelector('.topBar');
                        const deletebtn = $modal.querySelector('.deleteBox');
                        exit.onclick = () => {
                            $modal.style.display = "none";
                        }
                        deletebtn.onclick = async ()=>{
                            if(window.confirm("삭제할가요?")){
                                const res = await fetch(localStorage.getItem('url')+"post/"+e.target.id, {
                                    method : "delete",
                                    headers: {
                                        "Authorization" : "Bearer "+localStorage.getItem("key"),
                                        "Content-Type": "application/json"
                                    }
                                })
                                const resJson = await res.json();
                                alert(resJson.message);
                                $modal.style.display = "none";
                                mylist();
                            } else{
                            }
                        }
                    }
                }
                
        }
        }
        // 좋아요
        let heartCheck = async (id)=>{
            await fetch(localStorage.getItem("url")+"post/"+id+"/heart",{
                method: "post",
                headers: {
                    "Authorization" : "Bearer "+localStorage.getItem("key"),
                    "Content-Type": "application/json"
                }
            }).then((data)=>{
                return data.json;
            }).then((data)=>{
                mylist();
            })
        }
        // 좋아요 취소
        let unheartCheck = async (id)=>{
            await fetch(localStorage.getItem("url")+"post/"+id+"/unheart",{
                method: "delete",
                headers: {
                    "Authorization" : "Bearer "+localStorage.getItem("key"),
                    "Content-Type": "application/json"
                }
            }).then((data)=>{
                return data.json;
            }).then((data)=>{
                mylist();
            })
        }

        mylist();
        album();
        ProductList();
        userinfo();
    </script>
</body>
</html>