<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/msy_modification.css">
    <title>profile - modification</title>
</head>
<body>
    <section class="top-upload-nav">
        <h2 class="blind">상단업로드네비게이션</h2>
        <div class="arrow"></div>
        <button class="save" disabled="disabled">저장</button>
    </section>
    <section class="modificationProfile">
        <div class="imageBox">
            <div class="userimg"></div>
            <label for="fi" class="imgUpdate"></label>
            <input type="file" id="fi"/>
        </div>
        <div class="properties">
            <div class="nameBox">
                <p>사용자 이름</p>
                <input type="text" class="userName">
                <strong class="nameerror">* 2~10자 이내여야합니다.</strong>
            </div>
            <div class="idBox">
                <p>계정 ID</p>
                <input type="text" class="userId">
                <strong class="iderror">* 영문, 숫자, 특수문자(.),(_)만 사용 가능합니다.</strong>
            </div>
            <div class="introBox">
                <p>소개</p>
                <input type="text" class="userIntro" placeholder="자신과 판매할 상품에 대해 소개해 주세요!">
            </div>
        </div>
    </section>

    
    <script>
        const body = document.querySelector('body');
        const username = body.querySelector('.userName');
        const nameerror = body.querySelector('.nameerror'); 
        const userid = body.querySelector('.userId');
        const userintro = body.querySelector('.userIntro');
        const iderror = body.querySelector('.iderror');
        const savebtn = body.querySelector('.save');
        const file = body.querySelector('#fi');
        let img;
        let [check1,check2,check3] = [false,false,false];
        // 이름 유효성 검사
        username.onblur =(e)=>{
            const length=e.target.value.length;
            if(length<2){
                check1=false;
                nameerror.style.display = 'block';
            }else if(length>10){
                check1=false;
                nameerror.style.display = 'block';
            }else {
                nameerror.style.display = 'none';
                check1=true;
            }
            check();
        }
        // 아이디 유효성 검사
        userid.onblur = (e)=> {
            const val=e.target.value;
            if(/[^a-z|^A-Z|^가-힣|^/.|^/_|^0-9]/g.test(val)||val.length<1) {
                iderror.style.display = 'block';
                check2 =false;
            }else {
                iderror.style.display = 'none';
                check2 =true;
            }
            check();
        }
        
        // 소개 유효성 검사
        userintro.onblur = (e)=>{
            const length=e.target.value.length;
            if(length>0){
                check3 =true;
            }else {
                check3 =false;
            }
            check();
        }
        // 버튼 활성화 확인
        function check(){
            if(check1==true&&check2==true&&check3==true) {
                savebtn.disabled = false;
            } else {
                savebtn.disabled = true;
            }
        }
        // api 통신
        const url = "http://146.56.183.55:5050/";
        savebtn.onclick = async ()=>{
            const image= url+await imgApi(img);
            console.log(image)
            const res = await fetch(url+"user", {
                method : "put",
                headers: {
                    "Authorization" : "Bearer "+localStorage.getItem("key"),
                    "Content-Type": "application/json"
                },
                body : JSON.stringify({
                    user : {
                        username: username.value,
                        accountname : userid.value,
                        intro : userintro.value,
                        image
                    }
                })
            })
            const resJson = await res.json();
            console.log(resJson);
        }

        // 이미지 업로드 및 보이기
        file.addEventListener('change',function(e){
            const f1=e.target.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(f1);
            reader.onload = ()=>{
                const user = body.querySelector('.userimg');
                user.style = `background : url(${reader.result}) no-repeat center center;`;
            }
            img=f1;
            console.log(img);
        })

        async function imgApi(img){
            const formdata = new FormData();
            formdata.append("image",img);
            const res = await fetch(url+"image/uploadfile",{
                method :"post",
                body : formdata
            }) 
            const result = await res.json();
            return result["filename"];
        }
    </script>
</body>
</html>